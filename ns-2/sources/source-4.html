


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > TransactionsServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.accountsservices.service.impl</a>
</div>

<h1>Coverage Summary for Class: TransactionsServiceImpl (com.example.accountsservices.service.impl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TransactionsServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    16.7%
  </span>
  <span class="absValue">
    (1/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    6.6%
  </span>
  <span class="absValue">
    (5/76)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TransactionsServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    14.3%
  </span>
  <span class="absValue">
    (1/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    6.4%
  </span>
  <span class="absValue">
    (5/78)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.accountsservices.service.impl;
&nbsp;
&nbsp;
&nbsp;import com.example.accountsservices.dto.outputDtos.OutputDto;
&nbsp;import com.example.accountsservices.dto.TransactionsDto;
&nbsp;import com.example.accountsservices.exception.AccountsException;
&nbsp;import com.example.accountsservices.exception.TransactionException;
&nbsp;import com.example.accountsservices.helpers.MapperHelper;
&nbsp;import com.example.accountsservices.model.Accounts;
&nbsp;import com.example.accountsservices.model.Customer;
&nbsp;import com.example.accountsservices.model.Transactions;
&nbsp;import com.example.accountsservices.repository.AccountsRepository;
&nbsp;import com.example.accountsservices.repository.CustomerRepository;
&nbsp;import com.example.accountsservices.repository.TransactionsRepository;
&nbsp;import com.example.accountsservices.service.AbstractAccountsService;
&nbsp;import com.example.accountsservices.helpers.SortDateComparator;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.stream.Collectors;
&nbsp;import static com.example.accountsservices.helpers.MapperHelper.*;
&nbsp;
&nbsp;@Service(&quot;transactionsServicePrimary&quot;)
&nbsp;public class TransactionsServiceImpl extends AbstractAccountsService {
<b class="fc">&nbsp;    private final Transactions.TransactionType CREDIT = Transactions.TransactionType.CREDIT;</b>
<b class="fc">&nbsp;    private final Transactions.TransactionType DEBIT = Transactions.TransactionType.DEBIT;</b>
&nbsp;    private final TransactionsRepository transactionsRepository;
&nbsp;    private final AccountsRepository accountsRepository;
&nbsp;
&nbsp;    TransactionsServiceImpl(TransactionsRepository transactionsRepository,
&nbsp;                            AccountsRepository accountsRepository,
&nbsp;                            CustomerRepository customerRepository) {
<b class="fc">&nbsp;        super(accountsRepository,customerRepository);</b>
<b class="fc">&nbsp;        this.transactionsRepository = transactionsRepository;</b>
<b class="fc">&nbsp;        this.accountsRepository = accountsRepository;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Transactions updateBalance(Accounts accounts, Transactions transactions, Long amount, Transactions.TransactionType transactionType) throws TransactionException {
<b class="nc">&nbsp;        String methodName=&quot;updateBalance(Accounts,Transactions,Long,Transactions.TransactionType ) in TransactionsServiceImpl&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        Long previousBalance = accounts.getBalance();</b>
&nbsp;
<b class="nc">&nbsp;        if (CREDIT.equals(transactionType)) {</b>
<b class="nc">&nbsp;            accounts.setBalance(previousBalance + amount);</b>
<b class="nc">&nbsp;            transactions.setTransactionType(CREDIT);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (DEBIT.equals(transactionType)) {</b>
<b class="nc">&nbsp;            if (previousBalance &gt;= amount) accounts.setBalance(previousBalance - amount);</b>
<b class="nc">&nbsp;            else throw new TransactionException(TransactionException.class,&quot;Insufficient Balance&quot;,methodName);</b>
<b class="nc">&nbsp;            transactions.setTransactionType(DEBIT);</b>
&nbsp;        }
&nbsp;
&nbsp;        //update the latest balance to accounts db
<b class="nc">&nbsp;        accountsRepository.save(accounts);</b>
<b class="nc">&nbsp;        return transactions;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param transactionsDto
&nbsp;     * @returnType AccountsDto
&nbsp;     */
&nbsp;    private TransactionsDto payOrDepositMoney(TransactionsDto transactionsDto, Transactions.TransactionType transactionType) throws AccountsException, TransactionException {
&nbsp;        //fetch account
<b class="nc">&nbsp;        Long accountNumber = transactionsDto.getAccountNumber();</b>
<b class="nc">&nbsp;        Accounts fetchedAccount = fetchAccountByAccountNumber(accountNumber);</b>
&nbsp;
&nbsp;        //converting to entity object
<b class="nc">&nbsp;        Transactions requestTransaction = mapToTransactions(transactionsDto);</b>
&nbsp;
&nbsp;        //get the money &amp; update the balance
<b class="nc">&nbsp;        Long amountToBeCredited = requestTransaction.getTransactionAmount();</b>
<b class="nc">&nbsp;        Transactions recentTransaction = updateBalance(fetchedAccount, requestTransaction,</b>
&nbsp;                amountToBeCredited, transactionType);
&nbsp;
&nbsp;        //some critical linkup before saving it to db
<b class="nc">&nbsp;        List&lt;Transactions&gt; listOfTransactions=new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        listOfTransactions.add(recentTransaction);</b>
<b class="nc">&nbsp;        fetchedAccount.setListOfTransactions(listOfTransactions);</b>
<b class="nc">&nbsp;        recentTransaction.setAccounts(fetchedAccount);</b>
&nbsp;
&nbsp;        //save in DB &amp; return
<b class="nc">&nbsp;        Transactions savedTransactions = transactionsRepository.save(recentTransaction);</b>
<b class="nc">&nbsp;        return mapToTransactionsDto(savedTransactions);</b>
&nbsp;    }
&nbsp;
&nbsp;    //using switch expression to decide debit or credit type transactions
&nbsp;    //among all transactions of descriptions like
&nbsp;    // EMI,CREDIT_CARD_BILL,DONATION,RENT,E_SHOPPING,
&nbsp;    // BUSINESS,INVESTMENT,FAMILY,ELECTRICITY,OTHERS
&nbsp;    //are all debit type transactions
&nbsp;    //only SALARY is credit type, we only add money ,so it&#39;s simple need not to add too much complexity
&nbsp;    //so just call payOrDeposit method to process the transaction
&nbsp;    @Override
&nbsp;    public OutputDto transactionsExecutor(TransactionsDto transactionsDto) throws TransactionException, AccountsException {
<b class="nc">&nbsp;        String methodName=&quot;transactionsExecutor(TransactionsDto) in TransactionsServiceImpl&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        Long accountNumber=transactionsDto.getAccountNumber();</b>
<b class="nc">&nbsp;        Accounts fetchedAccount=fetchAccountByAccountNumber(accountNumber);</b>
<b class="nc">&nbsp;        Customer fetchedCustomer=fetchedAccount.getCustomer();</b>
&nbsp;
<b class="nc">&nbsp;        if(null==transactionsDto.getTransactionType()) throw new TransactionException(TransactionException.class,</b>
&nbsp;                &quot;Please provide transaction Type&quot;,methodName);
<b class="nc">&nbsp;        switch (transactionsDto.getTransactionType()) {</b>
&nbsp;            case CREDIT -&gt; {
<b class="nc">&nbsp;                TransactionsDto transactionDetails=payOrDepositMoney(transactionsDto, CREDIT);</b>
<b class="nc">&nbsp;                return OutputDto.builder()</b>
<b class="nc">&nbsp;                        .customer(mapToCustomerOutputDto(mapToCustomerDto(fetchedCustomer)))</b>
<b class="nc">&nbsp;                        .accounts(mapToAccountsOutputDto(mapToAccountsDto(fetchedAccount)))</b>
<b class="nc">&nbsp;                        .transactions(transactionDetails)</b>
<b class="nc">&nbsp;                        .defaultMessage(String.format(&quot;Recent Transactions Details for account:%s&quot;,accountNumber))</b>
<b class="nc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;            case DEBIT -&gt; {
<b class="nc">&nbsp;                TransactionsDto transactionDetails=payBills(transactionsDto);</b>
<b class="nc">&nbsp;                return OutputDto.builder()</b>
<b class="nc">&nbsp;                        .customer(mapToCustomerOutputDto(mapToCustomerDto(fetchedCustomer)))</b>
<b class="nc">&nbsp;                        .accounts(mapToAccountsOutputDto(mapToAccountsDto(fetchedAccount)))</b>
<b class="nc">&nbsp;                        .transactions(transactionDetails)</b>
<b class="nc">&nbsp;                        .defaultMessage(String.format(&quot;Recent Transaction details for account:%s&quot;,accountNumber))</b>
<b class="nc">&nbsp;                        .build();</b>
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; throw new TransactionException(TransactionException.class,</b>
&nbsp;                    &quot;Please Specify a valid transaction type&quot;,methodName);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public OutputDto getPastSixMonthsTransactionsForAnAccount(Long accountNumber) throws  AccountsException{
&nbsp;        //fetch account
<b class="nc">&nbsp;        Accounts fetchedAccount=fetchAccountByAccountNumber(accountNumber);</b>
<b class="nc">&nbsp;        Customer loadedCustomer=fetchedAccount.getCustomer();</b>
&nbsp;
&nbsp;        //Calculate the  date six months before today&#39;s date
<b class="nc">&nbsp;        LocalDateTime today=LocalDateTime.now();</b>
<b class="nc">&nbsp;        LocalDateTime pastSixMonthsDate=today.minusMonths(6);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;Transactions&gt; listOfTransactions= new ArrayList&lt;&gt;(fetchedAccount.getListOfTransactions().</b>
<b class="nc">&nbsp;                stream().filter(transactions -&gt; transactions.getTransactionTimeStamp()</b>
<b class="nc">&nbsp;                        .isAfter(pastSixMonthsDate)).toList());</b>
&nbsp;
<b class="nc">&nbsp;        listOfTransactions.sort(new SortDateComparator());</b>
<b class="nc">&nbsp;        ArrayList&lt;TransactionsDto&gt; transactionsArrayList= listOfTransactions.stream()</b>
<b class="nc">&nbsp;                .map(MapperHelper::mapToTransactionsDto)</b>
<b class="nc">&nbsp;                .collect(Collectors.toCollection(ArrayList::new));</b>
&nbsp;
<b class="nc">&nbsp;        return OutputDto.builder()</b>
<b class="nc">&nbsp;                .customer(mapToCustomerOutputDto(mapToCustomerDto(loadedCustomer)))</b>
<b class="nc">&nbsp;                .accounts(mapToAccountsOutputDto(mapToAccountsDto(fetchedAccount)))</b>
<b class="nc">&nbsp;                .transactionsList(transactionsArrayList)</b>
<b class="nc">&nbsp;                .defaultMessage(String.format(&quot;Last 6 months transaction details for account:%s&quot;,accountNumber))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransactionsDto payBills(TransactionsDto transactionsDto) throws TransactionException, AccountsException {
<b class="nc">&nbsp;        String methodName=&quot;payBills(TransactionDto) in TransactionsServiceImpl&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        switch (transactionsDto.getDescription()) {</b>
&nbsp;            // this will be built along with loan microservices
&nbsp;            //we need to call Loan microservices apis
&nbsp;            case EMI -&gt; {
&nbsp;                //....................
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            //Do this for now, later we will build a scheduler to auto generate bills
&nbsp;            //every 30 days to  mimic a NACH/autopay system and have the amount to be paid
&nbsp;            case RENT -&gt; {
<b class="nc">&nbsp;               return payOrDepositMoney(transactionsDto,DEBIT);</b>
&nbsp;            }
&nbsp;
&nbsp;            //this wiil be built along with cards microservices
&nbsp;            //we need to call Cards microservices apis
&nbsp;            case CREDIT_CARD_BILL_PAYMENT -&gt; {
&nbsp;                //....................
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            //Do this for now, later we will build a scheduler to auto generate bills
&nbsp;            //every 30 days to  mimic a NACH/autopay system  and have the amount to be paid
&nbsp;            case ELECTRICITY -&gt; {
<b class="nc">&nbsp;                return payOrDepositMoney(transactionsDto, DEBIT);</b>
&nbsp;            }
&nbsp;
&nbsp;            //Do this for now, later we will build a scheduler to auto generate bills
&nbsp;            //every 30 days to mimic a NACH/autopay system and have the amount to be paid
&nbsp;            case FAMILY -&gt; {
<b class="nc">&nbsp;                return payOrDepositMoney(transactionsDto, DEBIT);</b>
&nbsp;            }
&nbsp;
&nbsp;            //Do this for now, later we will build a scheduler to auto generate bills
&nbsp;            //every 30 days to  mimic a NACH/autopay system and have the amount to be paid
&nbsp;            case INVESTMENT -&gt; {
<b class="nc">&nbsp;                return payOrDepositMoney(transactionsDto, DEBIT);</b>
&nbsp;            }
&nbsp;
&nbsp;            //once in a while expense
&nbsp;            case E_SHOPPING, DONATION, BUSINESS, OTHERS -&gt; {
<b class="nc">&nbsp;                return payOrDepositMoney(transactionsDto, DEBIT);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            default -&gt; throw  new TransactionException(TransactionException.class,</b>
&nbsp;                    &quot;we do not support this types of transaction yet&quot;,methodName);
&nbsp;        }
<b class="nc">&nbsp;        return transactionsDto;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-06-18 13:59</div>
</div>
</body>
</html>
